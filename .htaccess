# ================================================
# SCCDMS .htaccess - Modern & Secure Version 2026
# ================================================

# 1. Enable rewrite engine (required for redirects & rules)
RewriteEngine On
RewriteBase /

# 2. FORCE HTTPS (all traffic → HTTPS) – prevents mixed content & cookie leaks
RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP:X-Forwarded-Proto} !https [NC]   # Handles proxies/load balancers like DigitalOcean
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301,NE]

# 3. DirectoryIndex – default file when no filename given
DirectoryIndex index.php index.html

# 4. Disable directory listing (already good – kept)
Options -Indexes

# 5. Protect sensitive files & directories
<FilesMatch "(?i)^\.env|\.git|\.gitignore|config\.php|database\.sql|composer\.json|composer\.lock|\.htaccess$">
    Require all denied
</FilesMatch>

# Block access to backup / log / temp files
<Files ~ "\.(bak|old|backup|~|\.sql\.gz|\.log)$">
    Require all denied
</Files>

# 6. Custom error pages (kept & improved – use full path if needed)
ErrorDocument 400 /pages/error.php?code=400
ErrorDocument 401 /pages/error.php?code=401
ErrorDocument 403 /pages/error.php?code=403
ErrorDocument 404 /pages/error.php?code=404
ErrorDocument 500 /pages/error.php?code=500

# 7. Security Headers (OWASP / modern browser recommendations)
<IfModule mod_headers.c>
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self'; form-action 'self'; upgrade-insecure-requests;"
    Header always set X-Permitted-Cross-Domain-Policies "none"
    Header always set Cross-Origin-Resource-Policy "same-origin"
    Header always set Cross-Origin-Opener-Policy "same-origin"
    Header always set Cross-Origin-Embedder-Policy "require-corp"
</IfModule>

# 8. Optional: Block bad bots & common scanners (uncomment if you want stricter)
# RewriteCond %{HTTP_USER_AGENT} (badbot|scanner|sqlmap|nikto|havij|acunetix) [NC,OR]
# RewriteCond %{REQUEST_URI} (\.env|wp-config\.php|phpmyadmin|xmlrpc\.php) [NC]
# RewriteRule .* - [F,L]

# 9. Prevent hotlinking of images/PDFs (optional – uncomment if needed)
# RewriteCond %{HTTP_REFERER} !^$
# RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
# RewriteRule \.(jpg|jpeg|png|gif|pdf|doc|docx)$ - [F,L]

# End of file
